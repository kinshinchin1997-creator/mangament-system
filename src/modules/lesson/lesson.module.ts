import { Module, forwardRef } from '@nestjs/common';
import { LessonController } from './lesson.controller';
import { LessonService } from './lesson.service';
import { ContractModule } from '../contract/contract.module';
import { PrismaModule } from '../../prisma/prisma.module';

/**
 * ============================================
 * 消课模块 - Lesson Module
 * ============================================
 * 
 * 核心职责：
 * 1. 上课签到 → 消课记录
 * 2. 自动计算收入确认
 * 3. 消课撤销与回滚
 * 4. 消课统计与报表
 * 
 * 业务模型：
 * ┌─────────────────────────────────────────────────────────────┐
 * │                    消课 = 收入确认                           │
 * ├─────────────────────────────────────────────────────────────┤
 * │                                                             │
 * │  教培行业的收入确认遵循"权责发生制"：                          │
 * │  - 收到学费时：形成预收款（负债）                              │
 * │  - 上课消耗时：确认收入（减少负债）                            │
 * │                                                             │
 * │  核心公式：                                                  │
 * │  ┌────────────────────────────────────────────────┐        │
 * │  │ 预收款余额 = 已收金额 - 已确认收入                 │        │
 * │  │ 已确认收入 = 已消课时 × 课单价                    │        │
 * │  │ 未消课金额 = 剩余课时 × 课单价                    │        │
 * │  └────────────────────────────────────────────────┘        │
 * │                                                             │
 * └─────────────────────────────────────────────────────────────┘
 * 
 * 消课流程：
 * ┌─────────────────────────────────────────────────────────────┐
 * │                                                             │
 * │  ┌──────────┐                                               │
 * │  │  排课    │  系统或人工安排课程                             │
 * │  └────┬─────┘                                               │
 * │       │                                                     │
 * │       v                                                     │
 * │  ┌──────────┐                                               │
 * │  │  上课    │  教师按排课进行授课                             │
 * │  └────┬─────┘                                               │
 * │       │                                                     │
 * │       v                                                     │
 * │  ┌──────────┐                                               │
 * │  │  签到    │  记录学员出勤状态                               │
 * │  └────┬─────┘                                               │
 * │       │                                                     │
 * │       ├─── 正常签到 ──> 消课（扣课时、确认收入）               │
 * │       │                                                     │
 * │       ├─── 请假 ────> 不消课（可安排补课）                    │
 * │       │                                                     │
 * │       └─── 缺勤 ────> 根据策略处理                           │
 * │                                                             │
 * └─────────────────────────────────────────────────────────────┘
 * 
 * 异常处理：
 * ┌─────────────────────────────────────────────────────────────┐
 * │  场景          │  处理方式                │  是否扣课时     │
 * ├─────────────────────────────────────────────────────────────┤
 * │  正常出勤      │  创建消课记录             │  ✅ 扣课时      │
 * │  请假          │  记录请假，不创建消课      │  ❌ 不扣        │
 * │  缺勤(仁慈)    │  记录缺勤，不扣课         │  ❌ 不扣        │
 * │  缺勤(严格)    │  创建缺勤扣课记录         │  ✅ 扣课时      │
 * │  补课          │  创建补课消课记录         │  ✅ 扣课时      │
 * │  撤销          │  恢复课时和金额           │  ↩️ 恢复        │
 * └─────────────────────────────────────────────────────────────┘
 * 
 * 金额管理规则：
 * 【重要】不允许直接修改未消课金额！
 * 所有金额变化只能通过以下途径：
 * 1. 消课 → 减少未消课金额
 * 2. 撤销消课 → 恢复未消课金额
 * 3. 退费 → 清零未消课金额
 * 
 * 依赖关系：
 * - 依赖 PrismaModule 进行数据库操作
 * - 依赖 ContractModule 获取合同信息
 * - 被 ReportModule 依赖（消课统计报表）
 * - 被 DashboardModule 依赖（消课数据看板）
 */
@Module({
  imports: [
    PrismaModule,
    forwardRef(() => ContractModule),
  ],
  controllers: [LessonController],
  providers: [LessonService],
  exports: [LessonService],
})
export class LessonModule {}
