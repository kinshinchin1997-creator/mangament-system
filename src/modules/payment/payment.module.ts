import { Module, forwardRef } from '@nestjs/common';
import { PaymentController } from './payment.controller';
import { PaymentService } from './payment.service';
import { PrismaModule } from '../../prisma/prisma.module';

/**
 * ============================================
 * 收款模块 - Payment Module
 * ============================================
 * 
 * 核心职责：
 * 1. 处理新招收款（新学员首次购买）
 * 2. 处理续费收款（老学员续购）
 * 3. 预收款统计与管理
 * 4. 收款记录查询
 * 
 * 业务模型：
 * ┌─────────────────────────────────────────────────────────────┐
 * │                     收款业务流程                              │
 * ├─────────────────────────────────────────────────────────────┤
 * │                                                             │
 * │   ┌──────────┐                ┌──────────┐                  │
 * │   │  新招    │                │  续费    │                  │
 * │   │ (SIGN)   │                │(RENEWAL) │                  │
 * │   └────┬─────┘                └────┬─────┘                  │
 * │        │                          │                         │
 * │        v                          v                         │
 * │   ┌──────────────────────────────────────┐                  │
 * │   │           创建合同 (Contract)          │                  │
 * │   │   - 绑定学员 (Student)                 │                  │
 * │   │   - 绑定课包 (CoursePackage)           │                  │
 * │   │   - 计算预收金额                        │                  │
 * │   └────────────────┬─────────────────────┘                  │
 * │                    │                                        │
 * │                    v                                        │
 * │   ┌──────────────────────────────────────┐                  │
 * │   │           创建收款 (Payment)           │                  │
 * │   │   - 绑定合同                           │                  │
 * │   │   - 记录支付信息                        │                  │
 * │   └────────────────┬─────────────────────┘                  │
 * │                    │                                        │
 * │                    v                                        │
 * │   ┌──────────────────────────────────────┐                  │
 * │   │           预收款余额 (Unearned)        │                  │
 * │   │   = 已收金额 - 已消课金额               │                  │
 * │   │   = 剩余课时 × 课单价                   │                  │
 * │   └──────────────────────────────────────┘                  │
 * │                                                             │
 * └─────────────────────────────────────────────────────────────┘
 * 
 * 核心概念：
 * - 预收款(Prepaid)：收到学员的钱，形成负债（欠学员课时）
 * - 未消课金额(Unearned)：预收款余额，表示还欠学员多少课时的价值
 * - 已确认收入(Earned)：通过消课确认的收入 = 预收款 - 未消课金额
 * 
 * 依赖关系：
 * - 依赖 PrismaModule 进行数据库操作
 * - 被 ContractModule 依赖（合同创建时调用收款）
 * - 被 CashflowModule 依赖（现金流统计）
 */
@Module({
  imports: [
    PrismaModule,
  ],
  controllers: [PaymentController],
  providers: [PaymentService],
  exports: [PaymentService],
})
export class PaymentModule {}
