import { Module, forwardRef } from '@nestjs/common';
import { RefundController } from './refund.controller';
import { RefundService } from './refund.service';
import { CashflowModule } from '../cashflow/cashflow.module';

/**
 * 退费模块（资金流出）
 * 
 * ============================================
 * 职责：
 * ============================================
 * - 退费申请与审批流程
 * - 可退金额自动计算（基于未消课金额）
 * - 退费风控校验（单人退费率、校区退费率）
 * - 退费打款确认
 * - 产生资金流出记录
 * 
 * ============================================
 * 审批流：
 * ============================================
 * 
 *   ┌─────────┐     ┌─────────┐     ┌─────────┐
 *   │ PENDING │────▶│ APPROVED│────▶│COMPLETED│
 *   │ 待审批  │     │ 已通过  │     │ 已完成  │
 *   └─────────┘     └─────────┘     └─────────┘
 *        │
 *        ▼
 *   ┌─────────┐
 *   │REJECTED │
 *   │ 已驳回  │
 *   └─────────┘
 * 
 * ============================================
 * 财务意义：
 * ============================================
 * 退费是教培行业主要的资金流出渠道
 * 退费 = 预收款负债减少 + 现金流出
 * 
 * 可退金额 = 未消课金额 = 剩余课时 × 课时单价
 * 实退金额 = 可退金额 - 扣除金额（违约金等）
 * 
 * ============================================
 * 风控规则：
 * ============================================
 * 1. 单人退费率：监控单个学员的历史退费情况
 * 2. 校区退费率：监控校区整体退费趋势
 * 3. 金额风控：大额退费需要更高级别审批
 * 
 * 风控配置点（可扩展）：
 * - 新签合同X天内退费限制
 * - 同一课包多人退费预警
 * - 销售员客户退费率
 * - 季节性退费异常检测
 */
@Module({
  imports: [forwardRef(() => CashflowModule)],
  controllers: [RefundController],
  providers: [RefundService],
  exports: [RefundService],
})
export class RefundModule {}
